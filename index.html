<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Roteirização de Vistorias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; }
        #topo { padding:15px; background:#1f4fd8; color:white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #contador { font-size:14px; opacity:0.9; display: block; margin-top: 5px; }
        #map { height:45vh; width: 100%; border-bottom: 2px solid #ddd; }
        #painel { padding:15px; height: calc(55vh - 70px); overflow-y:auto; box-sizing: border-box; }
        
        .secao { background: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h3 { margin-top: 0; font-size: 16px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        
        input[type="text"], input[type="number"] { width:100%; padding:10px; margin:8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .resultado-busca, .escola-item { display:flex; align-items:center; justify-content:space-between; padding:8px; border-bottom: 1px solid #eee; font-size: 13px; }
        .escola-item button { background:#ff4d4d; color:white; border:none; padding:5px 10px; border-radius: 4px; cursor:pointer; }
        
        .rota-item { background: white; padding: 12px; margin-bottom: 12px; border-radius: 8px; border-left: 6px solid #1f4fd8; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .rota-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .rota-titulo { font-weight: bold; color: #1f4fd8; }
        .btn-google { background: #4285F4; color: white; text-decoration: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        
        .lista-escolas-rota { margin: 0; padding-left: 20px; font-size: 13px; color: #555; }
        .lista-escolas-rota li { margin-bottom: 4px; }

        #gerar-rotas { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: bold; transition: 0.3s; }
        #gerar-rotas:hover { background: #218838; }
        #gerar-rotas:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="topo">
    <strong>Roteirização de Vistorias</strong>
    <span id="contador">0 escolas selecionadas</span>
</div>

<div id="map"></div>

<div id="painel">
    <div class="secao">
        <h3>1. Buscar Escola</h3>
        <input type="text" id="busca" placeholder="Ex: Nome da escola...">
        <div id="resultados-busca"></div>
    </div>

    <div class="secao">
        <h3>2. Escolas Selecionadas</h3>
        <div id="lista-escolas"><em>Nenhuma selecionada.</em></div>
    </div>

    <div class="secao">
        <h3>3. Configuração</h3>
        <label>Quantidade de Veículos (Rotas):</label>
        <input type="number" id="num-rotas" min="1" value="2">
        <label>Máximo de escolas por veículo:</label>
        <input type="number" id="max-escolas" min="1" value="5">
        <button id="gerar-rotas">Gerar Rotas Otimizadas</button>
    </div>

    <div id="container-rotas">
        </div>
</div>

<script>
// Configurações Iniciais
const pontoPartida = { nome:"SEINFRA", lat:-7.194722139209482, lng:-39.31536456230205 };
const escolas = [
    { id:1, nome: "ALAYDE OLIVEIRA DE ANDRADE CEI", lat:-7.22591062068273, lng:-39.29902763710780 },
    { id:2, nome: "HELENA VIEIRA DOS SANTOS EMEI", lat:-7.21989883926041, lng:-39.33797808195100 },
    { id:3, nome: "IRMÃ ANA TEREZINHA EMEI", lat:-7.20154173144659, lng:-39.27063735387350 },
    { id:4, nome: "PROFª FRANCISCA LETICIA DO AMARAL BRASILEIRO EMEI", lat:-7.22819953348265, lng:-39.34014211541830 },
    { id:5, nome: "PROFª MARIA BERNADETE DE ALENCAR SANTOS EMEI", lat:-7.23045717488514, lng:-39.32037563243490 },
    { id:6, nome: "PROFª MANOELA RIBEIRO SALVIANO EMEI", lat:-7.23370145013908, lng:-39.30402430844510 }
];

let escolasSelecionadas = [];
let marcadores = {};
let linhasRotas = [];

// Inicializa Mapa
const map = L.map("map").setView([pontoPartida.lat, pontoPartida.lng], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const iconePadrao = L.icon({ iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png", shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize:[20,32], iconAnchor:[10,32] });
const iconeVerde = L.icon({ iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png", shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize:[20,32], iconAnchor:[10,32] });
const iconeBase = L.icon({ iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png", shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize:[22,36], iconAnchor:[11,36] });

L.marker([pontoPartida.lat, pontoPartida.lng], {icon:iconeBase}).addTo(map).bindPopup("<b>SEINFRA</b> (Ponto de Partida)");

escolas.forEach(e => {
    const m = L.marker([e.lat, e.lng], {icon:iconePadrao}).addTo(map);
    m.selecionado = false;
    m.on("click", () => alternarEscola(e, true));
    marcadores[e.id] = m;
});

function alternarEscola(e, darZoom = false) {
    const m = marcadores[e.id];
    const index = escolasSelecionadas.findIndex(item => item.id === e.id);

    if (index === -1) {
        escolasSelecionadas.push(e);
        m.setIcon(iconeVerde);
        m.selecionado = true;
    } else {
        escolasSelecionadas.splice(index, 1);
        m.setIcon(iconePadrao);
        m.selecionado = false;
    }
    
    if(darZoom) map.setView([e.lat, e.lng], 15);
    atualizarUI();
    atualizarBusca();
}

function atualizarUI() {
    document.getElementById("contador").textContent = `${escolasSelecionadas.length} escolas selecionadas`;
    const lista = document.getElementById("lista-escolas");
    lista.innerHTML = "";
    
    if(escolasSelecionadas.length === 0) {
        lista.innerHTML = "<em>Nenhuma selecionada.</em>";
        return;
    }

    escolasSelecionadas.forEach(e => {
        const div = document.createElement("div");
        div.className = "escola-item";
        div.innerHTML = `<span>${e.nome}</span><button onclick='alternarEscolaById(${e.id})'>Remover</button>`;
        lista.appendChild(div);
    });
}

function alternarEscolaById(id) {
    const escola = escolas.find(e => e.id === id);
    alternarEscola(escola);
}

function atualizarBusca() {
    const termo = document.getElementById("busca").value.toLowerCase();
    const resultados = document.getElementById("resultados-busca");
    resultados.innerHTML = "";
    if(termo.length < 2) return;

    escolas.filter(e => e.nome.toLowerCase().includes(termo)).forEach(e => {
        const div = document.createElement("div");
        div.className = "resultado-busca";
        const isChecked = escolasSelecionadas.some(s => s.id === e.id);
        div.innerHTML = `
            <input type="checkbox" ${isChecked ? 'checked' : ''} onchange='alternarEscolaById(${e.id})'>
            <label>${e.nome}</label>
        `;
        resultados.appendChild(div);
    });
}
document.getElementById("busca").addEventListener("input", atualizarBusca);

// --- FUNÇÃO PARA DECODIFICAR O TRAÇADO DAS RUAS ---
function decodePolyline(str) {
    let index = 0, lat = 0, lng = 0, coordinates = [], shift = 0, result = 0, byte = null, lat_change, lng_change;
    while (index < str.length) {
        byte = null; shift = 0; result = 0;
        do { byte = str.charCodeAt(index++) - 63; result |= (byte & 0x1f) << shift; shift += 5; } while (byte >= 0x20);
        lat_change = ((result & 1) ? ~(result >> 1) : (result >> 1)); lat += lat_change;
        byte = null; shift = 0; result = 0;
        do { byte = str.charCodeAt(index++) - 63; result |= (byte & 0x1f) << shift; shift += 5; } while (byte >= 0x20);
        lng_change = ((result & 1) ? ~(result >> 1) : (result >> 1)); lng += lng_change;
        coordinates.push([lat / 100000, lng / 100000]);
    }
    return coordinates;
}

// --- GERAÇÃO DE ROTAS ---
async function gerarRotas() {
    if(escolasSelecionadas.length === 0) return alert("Selecione as escolas primeiro.");
    
    // Limpa rotas anteriores do mapa
    linhasRotas.forEach(l => map.removeLayer(l));
    linhasRotas = [];

    const btn = document.getElementById("gerar-rotas");
    btn.disabled = true; btn.textContent = "Otimizando Trajeto...";

    const jobs = escolasSelecionadas.map(e => ({ id: e.id, location: [e.lng, e.lat], amount: [1] }));
    const nRotas = parseInt(document.getElementById("num-rotas").value);
    const max = parseInt(document.getElementById("max-escolas").value);
    
    const vehicles = [];
    for(let i=0; i<nRotas; i++) {
        vehicles.push({ id: i, profile: "driving-car", start: [pontoPartida.lng, pontoPartida.lat], end: [pontoPartida.lng, pontoPartida.lat], capacity: [max] });
    }

    try {
        const resp = await fetch("https://redefisica.onrender.com/rotas", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ jobs, vehicles })
        });
        const data = await resp.json();
        btn.disabled = false; btn.textContent = "Gerar Rotas Otimizadas";

        if(data.error) throw new Error(data.error);

        const container = document.getElementById("container-rotas");
        container.innerHTML = "<h3>Rotas Calculadas</h3>";

        data.routes.forEach((rota, i) => {
            const cor = `hsl(${(i * 130) % 360}, 70%, 45%)`;
            
            // 1. Identificar Escolas na ordem da rota
            const stepsEscolas = rota.steps.filter(s => s.type === "job");
            const listaEscolasHtml = stepsEscolas.map(s => {
                const esc = escolas.find(e => e.id === s.job_id);
                return `<li>${esc.nome}</li>`;
            }).join("");

            // 2. Criar Link do Google Maps
            // Formato: /dir/Origem/Parada1/Parada2/Destino
            const coordsLink = rota.steps.map(s => `${s.location[1]},${s.location[0]}`);
            const urlGoogle = `https://www.google.com/maps/dir/${coordsLink.join("/")}`;

            // 3. Adicionar na UI
            const divRota = document.createElement("div");
            divRota.className = "rota-item";
            divRota.style.borderLeftColor = cor;
            divRota.innerHTML = `
                <div class="rota-header">
                    <span class="rota-titulo">ROTA ${i+1} (${(rota.distance/1000).toFixed(1)} km)</span>
                    <a href="${urlGoogle}" target="_blank" class="btn-google">Google Maps ↗</a>
                </div>
                <ol class="lista-escolas-rota">${listaEscolasHtml}</ol>
            `;
            container.appendChild(divRota);

            // 4. Desenhar no Mapa (Traçado Real)
            if(rota.geometry) {
                const caminhosReal = decodePolyline(rota.geometry);
                const poly = L.polyline(caminhosReal, {color: cor, weight: 6, opacity: 0.8}).addTo(map);
                linhasRotas.push(poly);
            }
        });

        // Ajustar zoom para ver todas as rotas
        if(linhasRotas.length > 0) {
            map.fitBounds(new L.featureGroup(linhasRotas).getBounds());
        }

    } catch (e) {
        alert("Erro: " + e.message);
        btn.disabled = false; btn.textContent = "Gerar Rotas Otimizadas";
    }
}

document.getElementById("gerar-rotas").addEventListener("click", gerarRotas);
</script>
</body>
</html>
