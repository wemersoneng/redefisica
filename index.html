<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Roteirização de Vistorias</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin: 0; font-family: Arial, Helvetica, sans-serif; }
    #topo { padding: 10px; background: #1f4fd8; color: white; }
    #contador { font-size: 14px; opacity: 0.9; }
    #map { height: 55vh; }
    #painel { padding: 10px; max-height: 45vh; overflow-y: auto; background: #f5f5f5; }
    input, button { width: 100%; margin: 4px 0; padding: 6px; }
    .bloco { background: white; padding: 6px; margin-bottom: 8px; border-radius: 4px; }
  </style>
</head>

<body>

<div id="topo">
  <strong>Roteirização de Vistorias<br>
  <span id="contador">0 escolas selecionadas</span></strong>
</div>

<div id="map"></div>

<div id="painel">

  <strong>Buscar escola</strong>
  <input type="text" id="busca" placeholder="Digite parte do nome">
  <div id="resultados-busca"></div>

  <hr>

  <strong>Escolas selecionadas</strong>
  <div id="lista-escolas"><em>Nenhuma escola selecionada.</em></div>

  <hr>

  <strong>Parâmetros da operação</strong>
  <input type="number" id="numRotas" min="1" value="1" placeholder="Número de rotas">
  <input type="number" id="maxPorRota" min="1" value="5" placeholder="Máx. por rota">
  <button onclick="gerarRotas()">GERAR ROTAS</button>

  <hr>

  <div id="resultado-rotas"></div>
</div>

<script>
const pontoPartida = { lat: -7.19472, lng: -39.31536 };

const escolas = [ { nome: "ALAYDE OLIVEIRA DE ANDRADE CEI", lat: -7.22591062068273, lng: -39.29902763710780 }, { nome: "HELENA VIEIRA DOS SANTOS EMEI", lat: -7.21989883926041, lng: -39.33797808195100 }, { nome: "IRMÃ ANA TEREZINHA EMEI", lat: -7.20154173144659, lng: -39.27063735387350 }, { nome: "PROFª FRANCISCA LETICIA DO AMARAL BRASILEIRO EMEI", lat: -7.22819953348265, lng: -39.34014211541830 }, { nome: "PROFª MARIA BERNADETE DE ALENCAR SANTOS EMEI", lat: -7.23045717488514, lng: -39.32037563243490 }, { nome: "PROFª MANOELA RIBEIRO SALVIANO EMEI", lat: -7.23370145013908, lng: -39.30402430844510 }, { nome: "ANA AMÉLIA BEZERRA DE MENEZES E SOUZA CEI", lat: -7.22167008303821, lng: -39.31205352283060 }, { nome: "CAIC - DOM ANTÔNIO CAMPELO DE ARAGÃO CEI", lat: -7.24575342177806, lng: -39.33808108252610 }, { nome: "DRA. ZILDA ARNS CEI", lat: -7.24803414389138, lng: -39.28818071378180 }, { nome: "IRMÃ NELY SOBREIRA EMEI", lat: -7.22127336881870, lng: -39.30495688808320 }, { nome: "PROFª FRANCISCA PEREIRA DE MATOS EMEI", lat: -7.20976881643100, lng: -39.30436156071580 }, { nome: "PROFª MARIA DA CONCEIÇÃO RIBEIRO DE SOUSA EMEI", lat: -7.25668606344500, lng: -39.33679274553820 }, { nome: "VEREADOR GETULIO GRANGEIRO PEREIRA CEI", lat: -7.21865806580961, lng: -39.29138697222790 }, { nome: "ADALGISA GOMES DE FIGUEREDO EMEI", lat: -7.26042254449341, lng: -39.33499142833630 }, { nome: "DAYSE SAMPAIO EMEI", lat: -7.19257120524175, lng: -39.32813794297350 }, { nome: "JOANA TERTULINA DE JESUS EMEI", lat: -7.21752233220798, lng: -39.33040228695120 }, { nome: "JOARYVAR MACÊDO EMEI", lat: -7.21230048797039, lng: -39.32834106355910 }, { nome: "JOSÉ PERBOYRE SAMPAIO SABIÁ EMEI", lat: -7.22791993798005, lng: -39.35296136595570 }, { nome: "MADRE MARIA VILLAC EMEI", lat: -7.21869772591523, lng: -39.29812692630730 }, { nome: "MARIA DIRCÍOLA GERMANO EMEI", lat: -7.26205983871444, lng: -39.32457321991130 } ];

const escolasSelecionadas = [];
const marcadores = {};

const map = L.map("map").setView([pontoPartida.lat, pontoPartida.lng], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

escolas.forEach(e => {
  const m = L.marker([e.lat, e.lng]).addTo(map);
  m.selecionado = false;
  m.on("click", () => alternarEscola(e));
  marcadores[e.nome] = m;
});

function distancia(a, b, c, d) {
  const R = 6371;
  const dLat = (c - a) * Math.PI / 180;
  const dLng = (d - b) * Math.PI / 180;
  return 2 * R * Math.asin(Math.sqrt(
    Math.sin(dLat/2)**2 +
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2
  ));
}

function ordenarEscolas() {
  escolasSelecionadas.sort((a,b) =>
    distancia(pontoPartida.lat,pontoPartida.lng,a.lat,a.lng) -
    distancia(pontoPartida.lat,pontoPartida.lng,b.lat,b.lng)
  );
}

function alternarEscola(e) {
  const m = marcadores[e.nome];
  if (!m.selecionado) {
    m.selecionado = true;
    escolasSelecionadas.push(e);
  } else {
    removerEscola(e.nome);
    return;
  }
  atualizarUI();
}

function removerEscola(nome) {
  const i = escolasSelecionadas.findIndex(e => e.nome === nome);
  if (i !== -1) escolasSelecionadas.splice(i,1);
  marcadores[nome].selecionado = false;
  atualizarUI();
}

function atualizarUI() {
  document.getElementById("contador").textContent =
    `${escolasSelecionadas.length} escolas selecionadas`;
}

function gerarRotas() {
  const n = +numRotas.value;
  const max = +maxPorRota.value;
  const out = document.getElementById("resultado-rotas");
  out.innerHTML = "";

  if (n * max < escolasSelecionadas.length) {
    alert("Capacidade insuficiente.");
    return;
  }

  ordenarEscolas();

  const rotas = Array.from({ length: n }, () => []);
  let i = 0;

  escolasSelecionadas.forEach(e => {
    while (rotas[i].length >= max) {
      i = (i + 1) % n;
    }
    rotas[i].push(e);
    i = (i + 1) % n;
  });

  rotas.forEach((rota, idx) => {
    if (!rota.length) return;

    let d = 0;
    d += distancia(pontoPartida.lat,pontoPartida.lng,rota[0].lat,rota[0].lng);
    for (let i=0;i<rota.length-1;i++)
      d += distancia(rota[i].lat,rota[i].lng,rota[i+1].lat,rota[i+1].lng);
    d += distancia(rota.at(-1).lat,rota.at(-1).lng,pontoPartida.lat,pontoPartida.lng);

    const div = document.createElement("div");
    div.className = "bloco";
    div.innerHTML = `<strong>ROTA ${idx+1}</strong><ul>${
      rota.map(e=>`<li>${e.nome}</li>`).join("")
    }</ul><em>${d.toFixed(2)} km</em>`;
    out.appendChild(div);
  });
}
</script>

</body>
</html>
