<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Roteirização de Vistorias</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: Arial, Helvetica, sans-serif; }
    #topo { padding:10px; background:#1f4fd8; color:white; font-size:16px; }
    #contador { font-size:14px; opacity:0.9; }
    #map { height:50vh; }
    #painel { padding:10px; max-height:50vh; overflow-y:auto; background:#f5f5f5; }
    input[type="text"], input[type="number"] { width:100%; padding:6px; margin:6px 0; font-size:14px; }
    .resultado-busca, .escola-item, .rota-item { display:flex; align-items:center; justify-content:space-between; padding:6px; margin-bottom:4px; background:white; border-radius:4px; font-size:14px; }
    .resultado-busca label { flex:1; margin-left:6px; cursor:pointer; }
    .escola-item button { background:#d9534f; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }
    .escola-item span { cursor:pointer; }
    .rota-item { flex-direction:column; background:#e3e3e3; padding:8px; }
    .rota-item span { font-weight:bold; margin-bottom:4px; }
    .rota-item a { display:inline-block; margin-top:6px; color:white; background:#1f4fd8; padding:4px 8px; border-radius:4px; text-decoration:none; }
  </style>
</head>
<body>

<div id="topo">
  <strong>
    Rotas - REDE FÍSICA<br>
    <span id="contador">0 escolas selecionadas</span>
  </strong>
</div>

<div id="map"></div>

<div id="painel">
  <strong>Buscar escola</strong>
  <input type="text" id="busca" placeholder="Digite parte do nome da escola">
  <div id="resultados-busca"></div>

  <hr>
  <strong>Escolas selecionadas</strong>
  <div id="lista-escolas"><em>Nenhuma escola selecionada.</em></div>

  <hr>
  <strong>Parâmetros da operação</strong>
  <label>Número de rotas:</label>
  <input type="number" id="num-rotas" min="1" value="2">
  <label>Máximo de escolas por rota:</label>
  <input type="number" id="max-escolas" min="1" value="5">
  <button id="gerar-rotas">Gerar Rotas</button>

  <hr>
  <strong>Rotas geradas</strong>
  <div id="rotas-geradas"></div>
</div>

<script>
const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImMwNzA3NmE4OGU1ZjQwNTRhNTI4M2ZkNzlmMTY4Y2Y2IiwiaCI6Im11cm11cjY0In0=";
const pontoPartida = { nome:"SEINFRA", lat:-7.194722139209482, lng:-39.31536456230205 };

const escolas = [
  { nome: "ALAYDE OLIVEIRA DE ANDRADE CEI", lat: -7.22591062068273, lng: -39.29902763710780 },
  { nome: "HELENA VIEIRA DOS SANTOS EMEI", lat: -7.21989883926041, lng: -39.33797808195100 },
  { nome: "IRMÃ ANA TEREZINHA EMEI", lat: -7.20154173144659, lng: -39.27063735387350 },
  { nome: "PROFª FRANCISCA LETICIA DO AMARAL BRASILEIRO EMEI", lat: -7.22819953348265, lng: -39.34014211541830 },
  { nome: "PROFª MARIA BERNADETE DE ALENCAR SANTOS EMEI", lat: -7.23045717488514, lng: -39.32037563243490 },
  { nome: "PROFª MANOELA RIBEIRO SALVIANO EMEI", lat: -7.23370145013908, lng: -39.30402430844510 },
  { nome: "ANA AMÉLIA BEZERRA DE MENEZES E SOUZA CEI", lat: -7.22167008303821, lng: -39.31205352283060 },
  { nome: "CAIC - DOM ANTÔNIO CAMPELO DE ARAGÃO CEI", lat: -7.24575342177806, lng: -39.33808108252610 },
  { nome: "DRA. ZILDA ARNS CEI", lat: -7.24803414389138, lng: -39.28818071378180 },
  { nome: "IRMÃ NELY SOBREIRA EMEI", lat: -7.22127336881870, lng: -39.30495688808320 },
  { nome: "PROFª FRANCISCA PEREIRA DE MATOS EMEI", lat: -7.20976881643100, lng: -39.30436156071580 },
  { nome: "PROFª MARIA DA CONCEIÇÃO RIBEIRO DE SOUSA EMEI", lat: -7.25668606344500, lng: -39.33679274553820 },
  { nome: "VEREADOR GETULIO GRANGEIRO PEREIRA CEI", lat: -7.21865806580961, lng: -39.29138697222790 },
  { nome: "ADALGISA GOMES DE FIGUEREDO EMEI", lat: -7.26042254449341, lng: -39.33499142833630 },
  { nome: "DAYSE SAMPAIO EMEI", lat: -7.19257120524175, lng: -39.32813794297350 },
  { nome: "JOANA TERTULINA DE JESUS EMEI", lat: -7.21752233220798, lng: -39.33040228695120 },
  { nome: "JOARYVAR MACÊDO EMEI", lat: -7.21230048797039, lng: -39.32834106355910 },
  { nome: "JOSÉ PERBOYRE SAMPAIO SABIÁ EMEI", lat: -7.22791993798005, lng: -39.35296136595570 },
  { nome: "MADRE MARIA VILLAC EMEI", lat: -7.21869772591523, lng: -39.29812692630730 },
  { nome: "MARIA DIRCÍOLA GERMANO EMEI", lat: -7.26205983871444, lng: -39.32457321991130 }
];

const escolasSelecionadas = [];
const marcadores = {};
let polylines = [];

// ========================= MAPA =========================
const map = L.map("map").setView([pontoPartida.lat, pontoPartida.lng], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const iconeEscola = L.icon({ iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png", shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize:[20,32], iconAnchor:[10,32] });
const iconeSelecionado = L.icon({ iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png", shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize:[20,32], iconAnchor:[10,32] });
const iconeSEINFRA = L.icon({ iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png", shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png", iconSize:[22,36], iconAnchor:[11,36] });

L.marker([pontoPartida.lat, pontoPartida.lng], {icon:iconeSEINFRA}).addTo(map).bindPopup("SEINFRA");

escolas.forEach(e=>{
  const m = L.marker([e.lat,e.lng], {icon:iconeEscola}).addTo(map);
  m.selecionado = false;
  m.on("click",()=>alternarEscola(e,true));
  marcadores[e.nome] = m;
});

// ========================= FUNÇÕES =========================
function alternarEscola(e,zoom=false){
  const m=marcadores[e.nome];
  if(!m.selecionado){ m.selecionado=true; m.setIcon(iconeSelecionado); escolasSelecionadas.push(e); }
  else{ removerEscola(e.nome); return; }
  if(zoom) map.setView([e.lat,e.lng],16);
  atualizarUI(); atualizarBusca();
}

function removerEscola(nome){
  const idx=escolasSelecionadas.findIndex(e=>e.nome===nome);
  if(idx!=-1) escolasSelecionadas.splice(idx,1);
  const m=marcadores[nome]; m.selecionado=false; m.setIcon(iconeEscola);
  atualizarUI(); atualizarBusca();
}

function atualizarUI(){
  document.getElementById("contador").textContent=`${escolasSelecionadas.length} escolas selecionadas`;
  const lista=document.getElementById("lista-escolas"); lista.innerHTML="";
  if(escolasSelecionadas.length==0){ lista.innerHTML="<em>Nenhuma escola selecionada.</em>"; return; }
  escolasSelecionadas.forEach(e=>{
    const div=document.createElement("div"); div.className="escola-item";
    const nome=document.createElement("span"); nome.textContent=e.nome; nome.onclick=()=>map.setView([e.lat,e.lng],16);
    const btn=document.createElement("button"); btn.textContent="Remover"; btn.onclick=()=>removerEscola(e.nome);
    div.appendChild(nome); div.appendChild(btn); lista.appendChild(div);
  });
}

function atualizarBusca(){
  const termo=document.getElementById("busca").value.toLowerCase();
  const resultados=document.getElementById("resultados-busca"); resultados.innerHTML="";
  if(termo.length<2) return;
  escolas.filter(e=>e.nome.toLowerCase().includes(termo)).forEach(e=>{
    const div=document.createElement("div"); div.className="resultado-busca";
    const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=marcadores[e.nome].selecionado;
    cb.onchange=()=>alternarEscola(e,true);
    const label=document.createElement("label"); label.textContent=e.nome;
    div.appendChild(cb); div.appendChild(label); resultados.appendChild(div);
  });
}

document.getElementById("busca").addEventListener("input", atualizarBusca);

// ========================= MATRIZ ORS =========================
async function obterMatrizDistancias(pontos) {
  const locations = pontos.map(p => [p.lng, p.lat]);
  const body = { locations, metrics:["distance"], units:"km" };
  try {
    const res = await fetch("https://api.openrouteservice.org/v2/matrix/driving-car", {
      method:"POST",
      headers: { "Authorization": ORS_API_KEY, "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    return data.distances;
  } catch(err) { console.error("Erro ORS:", err); return null; }
}

// ========================= GERAR ROTAS =========================
document.getElementById("gerar-rotas").addEventListener("click", async ()=>{
  if(escolasSelecionadas.length==0){ alert("Selecione ao menos uma escola"); return; }
  const nRotas=parseInt(document.getElementById("num-rotas").value);
  const maxEscolas=parseInt(document.getElementById("max-escolas").value);

  const pontos=[pontoPartida, ...escolasSelecionadas];
  const matriz = await obterMatrizDistancias(pontos);
  if(!matriz){ alert("Erro ao gerar matriz de distâncias ORS"); return; }

  // ===== Distribuição gulosa usando matriz de distâncias reais =====
  const rotas = Array.from({length:nRotas},()=>[]);
  let restantes = escolasSelecionadas.map((e,i)=>i+1); // índice na matriz (0 = pontoPartida)
  const seeds = [];

  // 1️⃣ Escolher seeds (escolas mais distantes)
  for(let i=0;i<nRotas;i++){
    if(restantes.length==0) break;
    let seedIdx;
    if(i==0){
      seedIdx = restantes.reduce((a,b)=>matriz[0][a]>matriz[0][b]?a:b);
    } else {
      seedIdx = restantes.reduce((a,b)=>{
        const dA = Math.min(...seeds.map(s=>matriz[s][a]), matriz[0][a]);
        const dB = Math.min(...seeds.map(s=>matriz[s][b]), matriz[0][b]);
        return dA>dB?a:b;
      });
    }
    seeds.push(seedIdx);
    rotas[i].push(seedIdx);
    restantes = restantes.filter(x=>x!==seedIdx);
  }

  // 2️⃣ Distribuição gulosa por distância
  let round=true;
  while(restantes.length>0 && round){
    round=false;
    for(let i=0;i<nRotas;i++){
      if(restantes.length==0) break;
      if(rotas[i].length>=maxEscolas) continue;
      const seed = rotas[i][0];
      let closest = restantes.reduce((a,b)=>matriz[seed][a]<matriz[seed][b]?a:b);
      rotas[i].push(closest);
      restantes = restantes.filter(x=>x!==closest);
      round=true;
    }
  }

  // 3️⃣ Sequenciamento simples TSP dentro da rota
  const rotasSequenciadas = rotas.map(r=>{
    if(r.length<=1) return r;
    const ordered = [r[0]];
    let toOrder = r.slice(1);
    let last = r[0];
    while(toOrder.length>0){
      let nextIdx=0, nextDist=matriz[last][toOrder[0]];
      for(let i=1;i<toOrder.length;i++){
        if(matriz[last][toOrder[i]]<nextDist){ nextIdx=i; nextDist=matriz[last][toOrder[i]]; }
      }
      last=toOrder[nextIdx];
      ordered.push(last);
      toOrder.splice(nextIdx,1);
    }
    return ordered;
  });

  // ===== Mostrar no painel =====
  const container=document.getElementById("rotas-geradas");
  container.innerHTML="";
  polylines.forEach(p=>map.removeLayer(p)); // limpa rotas anteriores
  polylines = [];

  rotasSequenciadas.forEach((r,i)=>{
    const div=document.createElement("div"); div.className="rota-item";

    // Distância total
    let totalKm=0;
    for(let j=0;j<r.length;j++){
      if(j==0) totalKm+=matriz[0][r[j]];
      else totalKm+=matriz[r[j-1]][r[j]];
    }
    totalKm+=matriz[r[r.length-1]][0];

    div.innerHTML=`<span>Rota ${i+1} — Estimativa: ${totalKm.toFixed(2)} km</span>`;

    // Lista escolas
    r.forEach(idx=>{
      const s = document.createElement("span"); s.textContent=pontos[idx].nome; div.appendChild(s);
    });

    // Link Google Maps
    let link = `https://www.google.com/maps/dir/${pontoPartida.lat},${pontoPartida.lng}`;
    r.forEach(idx=>{ link += `/${pontos[idx].lat},${pontos[idx].lng}`; });
    link += `/${pontoPartida.lat},${pontoPartida.lng}`;
    const btn=document.createElement("a"); btn.href=link; btn.target="_blank"; btn.textContent="Abrir rota no Maps";
    div.appendChild(btn);

    container.appendChild(div);

    // Traçar rota no mapa
    const coords = [ [pontoPartida.lat,pontoPartida.lng], ...r.map(idx=>[pontos[idx].lat,pontos[idx].lng]), [pontoPartida.lat,pontoPartida.lng] ];
    const poly = L.polyline(coords,{color:["red","blue","green","orange","purple"][i%5],weight:4}).addTo(map);
    polylines.push(poly);
  });
});
</script>
</body>
</html>
